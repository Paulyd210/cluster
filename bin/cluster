#!/usr/bin/env php
<?php

require dirname(__DIR__) . "/vendor/autoload.php";

use Amp\Cluster\Cluster;
use Amp\Cluster\ConsoleLogger;
use Amp\Loop;
use function Amp\Cluster\countCpuCores;

Loop::run(function () {
    $logger = new ConsoleLogger;
    $cluster = new Cluster(__DIR__ . "/../examples/test-worker.php");

    yield $cluster->start(countCpuCores());

    Cluster::onTerminate(function () use ($cluster) {
        $cluster->stop();
    });

    $iterator = $cluster->iterate();

    while (yield $iterator->advance()) {
        $data = $iterator->getCurrent();

        if ($data["type"] === ConsoleLogger::class) {
            $logger->log($data["level"], $data["message"], [
                'time' => $data["time"],
            ]);
        }
    }
});
